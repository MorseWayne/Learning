---
title: 进程和线程
icon: /assets/icons/article.svg
order: 1
category:
  - C++
---

一直在谈论进程，线程，并发编程，异步编程的概念，一直没有从一个通俗的角度去理解过，结合自己这么多年的编程经验，回过头来重新思考一下，进程是什么，线程又是什么？

其实大家看很多书籍和资料，都会看到这样一个结论：**进程是操作系统资源分配的最小单位，线程是操作系统调度的最小单位**。嗯...，可能很多人看到这句话觉得自己理解了，但是不一定真正理解到这句话的精髓。

## 引言

 **进程**(process)这个单词在维基的释义如下：

> In [computing](https://en.wikipedia.org/wiki/Computing), a **process** is the [instance](https://en.wikipedia.org/wiki/Instance_(computer_science)) of a [computer program](https://en.wikipedia.org/wiki/Computer_program) that is being executed by one or many [threads](https://en.wikipedia.org/wiki/Thread_(computing)).

这句话的解释非常不错，很直白的阐述了两个东西，第一点，进程是一个计算机程序(比如，可执行文件)的实例，其次，一个进程由多个线程组成。

其实更简化的说，`process`就是一个 **running program**。你通过构建你的源代码形成一个可执行文件，这是得到了一个`program`，当你在`shell`上执行这个`program`，它被操作系统加载，为其分配各种资源，操作系统就多了一个你自定义的`process`。

其次，进程是有自己独立运行的资源(包括内存，CPU，文件等)的，而且进程间的资源是独立，相互之间不受影响的，这个没有太多为什么，这是操作系统设计的一个准则，从经验上来看，这是一个很好的设计。所以，这就是为什么说“**进程是操作系统资源分配的最小单位**”。

那出现了进程的情况下，为什么还需要线程，不是只需要进程就ok了吗。嗯...，这是为什么呢？

这可能涉及到多方面的原因，我们知道操作系统为不同进程分配了不同独立的资源。操作系统的现代设计都是多任务的操作系统，必然存在不同之间的进程间的执行切换，这个切换开销是很大的(比如需要重新完成虚拟内存到物理内存的映射，并清空为上一个进程的存储映射关系的TLB缓存)。为了避免或者尽可能的减少这些开销，我们需要更加一个轻量的并发任务模型，所以提出了线程这个概念。

线程是将进程做了一个更小的划分，从而让操作系统有了更精细化的调度方式。一个进程内的多个线程共享进程的大部分资源，线程间的切换更加轻量，这也极大的满足了我们的并发编程模型的设计。一个进程由多个线程组成，线程是操作系统真正调度的一个最小单位，所以我们说**线程是操作系统调度的最小单位**。

## 理解上下文切换

上下文切换是操作系统进行任务调度时，进行任务切换前的一个非常重要的行为，无论是在单核系统还是多核的CPU上，这都是一个非常重要的设计。上下文切换是什么？简单理解，就是操作系统在切换到新的要执行的任务前，对当前正在执行的任务的现场(例如通用寄存器，程序计数器，RSP，RBP等)生成一个快照保存到内存中，以便于下次恢复它的执行时，程序跟什么都没有发生过一样，能够继续正常执行。

上下文切换有针对于进程级别，也有针对于线程级别的，这取决于下一个抢占CPU时间的线程和上一个让出CPU时间的的线程是否是共进程的，如果不是，那么这次切换也会引起进程的切换。

## 什么是缺页

可能在很多场合都提到这个概念，那**缺页**到底是什么？要理解缺页，首先要明白现代操作系统如何使用**虚拟内存**：
- **程序的视角**：每个进程都认为自己独享一整个巨大的、连续的地址空间（比如4GB）。这叫做**虚拟地址空间**。

- **硬件的现实**：物理内存（RAM）大小有限，而且可能同时运行着多个程序，物理内存无法同时装下所有数据。

为了解决这个矛盾，操作系统和CPU使用**分页**机制：
1. 将虚拟内存和物理内存都分割成固定大小的块（通常为4KB），称为**页**。
2. 操作系统为每个进程维护一个**页表**，作为“地图”或“翻译簿”，记录着**虚拟页号**到**物理页框号**的映射关系。
3. 如果一个虚拟页的内容不在物理内存中，页表会将其标记为**无效**。

做一个简单的比喻如下，帮助大家更好理解:

- **物理内存** = 你的**办公桌桌面**。空间很小，但访问速度极快。
- **硬盘** = 你身后的**文件柜**。空间很大，但存取速度慢。
- **虚拟地址空间** = 你脑海中所有**可能用到的文件清单**。
- **页表** = 一份**文件索引**，记录着清单上的某个文件当前是在桌面上还是在文件柜里。
- **缺页** = 你伸手去拿清单上的一个文件，但根据索引发现它**不在桌面上**。
    1. 你必须**起身（触发异常）**
    1. *去文件柜里找到它（磁盘I/O）
    1. 把它拿到桌面上来（加载到物理内存）
    1. 更新索引（修改页表）
    1. **最终才能进行**访问**
